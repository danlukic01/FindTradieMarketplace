@page "/settings"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject IUserApiService UserService

<PageTitle>Settings - FindTradie</PageTitle>

<link rel="stylesheet" href="css/settings.css" />

<div class="settings-page">
    <SavingModal Show="@isSaving" />
    <!-- Page Header -->
    <div class="settings-header">
        <div class="container">
            <h1>Settings</h1>
            <p>Manage your account preferences and privacy settings</p>
        </div>
    </div>

    <div class="container">
        <div class="settings-layout">
            <!-- Settings Sidebar -->
            <div class="settings-sidebar">
                <nav class="settings-nav">
                    <button class="nav-item @(activeSection == "account" ? "active" : "")"
                            @onclick='() => SetActiveSection("account")'>
                        <i class="icon-user"></i>
                        <span>Account</span>
                    </button>

                    <button class="nav-item @(activeSection == "profile" ? "active" : "")"
                            @onclick='() => SetActiveSection("profile")'>
                        <i class="icon-edit"></i>
                        <span>Profile</span>
                    </button>

                    <button class="nav-item @(activeSection == "notifications" ? "active" : "")"
                            @onclick='() => SetActiveSection("notifications")'>
                        <i class="icon-bell"></i>
                        <span>Notifications</span>
                        @if (unreadNotificationSettings)
                        {
                            <span class="notification-dot"></span>
                        }
                    </button>

                    <button class="nav-item @(activeSection == "privacy" ? "active" : "")"
                            @onclick='() => SetActiveSection("privacy")'>
                        <i class="icon-lock"></i>
                        <span>Privacy & Security</span>
                    </button>

                    @if (IsTradie)
                    {
                        <button class="nav-item @(activeSection == "billing" ? "active" : "")"
                                @onclick='() => SetActiveSection("billing")'>
                            <i class="icon-credit-card"></i>
                            <span>Billing & Subscription</span>
                        </button>
                    }

                    <button class="nav-item @(activeSection == "preferences" ? "active" : "")"
                            @onclick='() => SetActiveSection("preferences")'>
                        <i class="icon-settings"></i>
                        <span>Preferences</span>
                    </button>

                    <button class="nav-item @(activeSection == "connected" ? "active" : "")"
                            @onclick='() => SetActiveSection("connected")'>
                        <i class="icon-link"></i>
                        <span>Connected Accounts</span>
                    </button>

                    <button class="nav-item @(activeSection == "data" ? "active" : "")"
                            @onclick='() => SetActiveSection("data")'>
                        <i class="icon-database"></i>
                        <span>Data & Privacy</span>
                    </button>
                </nav>
            </div>

            <!-- Settings Content -->
            <div class="settings-content">
                @if (activeSection == "account")
                {
                    <!-- Account Settings -->
                    <div class="settings-section">
                        <h2 class="section-title">Account Settings</h2>
                        <p class="section-description">Manage your account details and authentication</p>

                        <div class="settings-card">
                            <h3 class="card-title">Personal Information</h3>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>First Name</label>
                                    <input type="text" class="form-control" @bind="settings.FirstName"
                                           @bind:event="oninput" @bind:after="OnSettingChanged" />
                                </div>
                                <div class="form-group">
                                    <label>Last Name</label>
                                    <input type="text" class="form-control" @bind="settings.LastName"
                                           @bind:event="oninput" @bind:after="OnSettingChanged" />
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Email Address</label>
                                <div class="input-with-badge">
                                    <input type="email" class="form-control" @bind="settings.Email" readonly />
                                    @if (settings.EmailVerified)
                                    {
                                        <span class="verified-badge">
                                            <i class="icon-check"></i> Verified
                                        </span>
                                    }
                                    else
                                    {
                                        <button class="btn btn-sm btn-outline" @onclick="VerifyEmail">
                                            Verify Email
                                        </button>
                                    }
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Phone Number</label>
                                <div class="input-with-badge">
                                    <input type="tel" class="form-control" @bind="settings.Phone"
                                           @bind:event="oninput" @bind:after="OnSettingChanged" />
                                    @if (settings.PhoneVerified)
                                    {
                                        <span class="verified-badge">
                                            <i class="icon-check"></i> Verified
                                        </span>
                                    }
                                    else
                                    {
                                        <button class="btn btn-sm btn-outline" @onclick="VerifyPhone">
                                            Verify Phone
                                        </button>
                                    }
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Date of Birth</label>
                                <input type="date" class="form-control" @bind="settings.DateOfBirth"
                                       @bind:after="OnSettingChanged" />
                            </div>
                        </div>

                        <div class="settings-card">
                            <h3 class="card-title">Password & Authentication</h3>

                            <div class="password-section">
                                <div class="password-info">
                                    <p><strong>Password</strong></p>
                                    <p class="text-muted">Last changed @settings.PasswordLastChanged</p>
                                </div>
                                <button class="btn btn-outline" @onclick="ChangePassword">
                                    Change Password
                                </button>
                            </div>

                            <div class="two-factor-section">
                                <div class="two-factor-info">
                                    <div>
                                        <p><strong>Two-Factor Authentication</strong></p>
                                        <p class="text-muted">Add an extra layer of security to your account</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" @bind="settings.TwoFactorEnabled"
                                               @bind:after="OnTwoFactorToggle" />
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <div class="sessions-section">
                                <h4>Active Sessions</h4>
                                <div class="sessions-list">
                                    @foreach (var session in activeSessions)
                                    {
                                        <div class="session-item">
                                            <div class="session-info">
                                                <p><strong>@session.Device</strong></p>
                                                <p class="text-muted">@session.Location • @session.LastActive</p>
                                            </div>
                                            @if (session.IsCurrent)
                                            {
                                                <span class="current-badge">Current</span>
                                            }
                                            else
                                            {
                                                <button class="btn btn-sm btn-outline"
                                                        @onclick="() => RevokeSession(session.Id)">
                                                    Revoke
                                                </button>
                                            }
                                        </div>
                                    }
                                </div>
                                <button class="btn btn-outline text-danger" @onclick="RevokeAllSessions">
                                    Sign Out All Other Sessions
                                </button>
                            </div>
                        </div>

                        <div class="settings-card danger-zone">
                            <h3 class="card-title text-danger">Danger Zone</h3>
                            <div class="danger-actions">
                                <div class="danger-item">
                                    <div>
                                        <p><strong>Deactivate Account</strong></p>
                                        <p class="text-muted">Temporarily disable your account</p>
                                    </div>
                                    <button class="btn btn-outline text-warning" @onclick="DeactivateAccount">
                                        Deactivate
                                    </button>
                                </div>
                                <div class="danger-item">
                                    <div>
                                        <p><strong>Delete Account</strong></p>
                                        <p class="text-muted">Permanently delete your account and all data</p>
                                    </div>
                                    <button class="btn btn-outline text-danger" @onclick="DeleteAccount">
                                        Delete Account
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else if (activeSection == "profile")
                {
                    <!-- Profile Settings -->
                    <div class="settings-section">
                        <h2 class="section-title">Profile Settings</h2>
                        <p class="section-description">Manage how others see you on FindTradie</p>

                        <div class="settings-card">
                            <h3 class="card-title">Profile Photo</h3>
                            <div class="photo-upload-section">
                                <div class="current-photo">
                                    @if (!string.IsNullOrEmpty(settings.ProfilePhoto))
                                    {
                                        <img src="@settings.ProfilePhoto" alt="Profile" />
                                    }
                                    else
                                    {
                                        <div class="photo-placeholder">
                                            <span>@settings.Initials</span>
                                        </div>
                                    }
                                </div>
                                <div class="photo-actions">
                                    <InputFile OnChange="HandlePhotoUpload" accept="image/*" id="photo-upload" hidden />
                                    <label for="photo-upload" class="btn btn-primary">
                                        <i class="icon-upload"></i> Upload New Photo
                                    </label>
                                    @if (!string.IsNullOrEmpty(settings.ProfilePhoto))
                                    {
                                        <button class="btn btn-outline text-danger" @onclick="RemovePhoto">
                                            Remove Photo
                                        </button>
                                    }
                                    <p class="helper-text">JPG, PNG or GIF. Max size 5MB.</p>
                                </div>
                            </div>
                        </div>

                        @if (IsTradie)
                        {
                            <div class="settings-card">
                                <h3 class="card-title">Business Profile</h3>
                                <p class="card-description">These settings are managed in your business profile</p>
                                <a href="/my-profile" class="btn btn-outline">
                                    Go to Business Profile <i class="icon-arrow-right"></i>
                                </a>
                            </div>
                        }
                        else
                        {
                            <div class="settings-card">
                                <h3 class="card-title">Public Profile</h3>
                                <div class="form-group">
                                    <label>Bio</label>
                                    <textarea class="form-control" @bind="settings.Bio"
                                              @bind:event="oninput" @bind:after="OnSettingChanged"
                                              rows="4" placeholder="Tell us a bit about yourself..."></textarea>
                                    <span class="char-count">@(settings.Bio?.Length ?? 0) / 500</span>
                                </div>

                                <div class="form-group">
                                    <label>Location</label>
                                    <input type="text" class="form-control" @bind="settings.Location"
                                           @bind:event="oninput" @bind:after="OnSettingChanged"
                                           placeholder="City, State" />
                                </div>
                            </div>
                        }
                    </div>
                }
                else if (activeSection == "notifications")
                {
                    <!-- Notification Settings -->
                    <div class="settings-section">
                        <h2 class="section-title">Notification Preferences</h2>
                        <p class="section-description">Choose how you want to be notified</p>

                        <div class="settings-card">
                            <h3 class="card-title">Email Notifications</h3>

                            <div class="notification-group">
                                <label class="notification-item">
                                    <div class="notification-info">
                                        <p><strong>Account Updates</strong></p>
                                        <p class="text-muted">Important updates about your account</p>
                                    </div>
                                    <input type="checkbox" @bind="settings.EmailAccountUpdates"
                                           @bind:after="OnSettingChanged" />
                                    <span class="checkbox-custom"></span>
                                </label>

                                @if (IsCustomer)
                                {
                                    <label class="notification-item">
                                        <div class="notification-info">
                                            <p><strong>Quote Received</strong></p>
                                            <p class="text-muted">When tradies send you quotes</p>
                                        </div>
                                        <input type="checkbox" @bind="settings.EmailQuoteReceived"
                                               @bind:after="OnSettingChanged" />
                                        <span class="checkbox-custom"></span>
                                    </label>

                                    <label class="notification-item">
                                        <div class="notification-info">
                                            <p><strong>Job Updates</strong></p>
                                            <p class="text-muted">Status changes for your jobs</p>
                                        </div>
                                        <input type="checkbox" @bind="settings.EmailJobUpdates"
                                               @bind:after="OnSettingChanged" />
                                        <span class="checkbox-custom"></span>
                                    </label>
                                }
                                else
                                {
                                    <label class="notification-item">
                                        <div class="notification-info">
                                            <p><strong>New Job Alerts</strong></p>
                                            <p class="text-muted">Jobs matching your services</p>
                                        </div>
                                        <input type="checkbox" @bind="settings.EmailNewJobs"
                                               @bind:after="OnSettingChanged" />
                                        <span class="checkbox-custom"></span>
                                    </label>

                                    <label class="notification-item">
                                        <div class="notification-info">
                                            <p><strong>Quote Accepted</strong></p>
                                            <p class="text-muted">When customers accept your quotes</p>
                                        </div>
                                        <input type="checkbox" @bind="settings.EmailQuoteAccepted"
                                               @bind:after="OnSettingChanged" />
                                        <span class="checkbox-custom"></span>
                                    </label>
                                }

                                <label class="notification-item">
                                    <div class="notification-info">
                                        <p><strong>Messages</strong></p>
                                        <p class="text-muted">New messages from users</p>
                                    </div>
                                    <input type="checkbox" @bind="settings.EmailMessages"
                                           @bind:after="OnSettingChanged" />
                                    <span class="checkbox-custom"></span>
                                </label>

                                <label class="notification-item">
                                    <div class="notification-info">
                                        <p><strong>Marketing & Promotions</strong></p>
                                        <p class="text-muted">Special offers and platform updates</p>
                                    </div>
                                    <input type="checkbox" @bind="settings.EmailMarketing"
                                           @bind:after="OnSettingChanged" />
                                    <span class="checkbox-custom"></span>
                                </label>
                            </div>
                        </div>

                        <div class="settings-card">
                            <h3 class="card-title">SMS Notifications</h3>

                            <div class="notification-group">
                                <label class="notification-item">
                                    <div class="notification-info">
                                        <p><strong>Urgent Notifications Only</strong></p>
                                        <p class="text-muted">Critical account and security alerts</p>
                                    </div>
                                    <input type="checkbox" @bind="settings.SmsUrgent"
                                           @bind:after="OnSettingChanged" />
                                    <span class="checkbox-custom"></span>
                                </label>

                                @if (IsTradie)
                                {
                                    <label class="notification-item">
                                        <div class="notification-info">
                                            <p><strong>Emergency Jobs</strong></p>
                                            <p class="text-muted">Urgent job opportunities in your area</p>
                                        </div>
                                        <input type="checkbox" @bind="settings.SmsEmergencyJobs"
                                               @bind:after="OnSettingChanged" />
                                        <span class="checkbox-custom"></span>
                                    </label>
                                }
                            </div>
                        </div>

                        <div class="settings-card">
                            <h3 class="card-title">Push Notifications</h3>

                            <div class="browser-permission">
                                @if (pushPermissionGranted)
                                {
                                    <div class="permission-granted">
                                        <i class="icon-check-circle"></i>
                                        <span>Browser notifications enabled</span>
                                    </div>
                                }
                                else
                                {
                                    <div class="permission-request">
                                        <p>Enable browser notifications to stay updated</p>
                                        <button class="btn btn-primary" @onclick="RequestPushPermission">
                                            Enable Notifications
                                        </button>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
                else if (activeSection == "privacy")
                {
                    <!-- Privacy & Security Settings -->
                    <div class="settings-section">
                        <h2 class="section-title">Privacy & Security</h2>
                        <p class="section-description">Control your privacy and security settings</p>

                        <div class="settings-card">
                            <h3 class="card-title">Profile Visibility</h3>

                            <div class="privacy-options">
                                <label class="privacy-item">
                                    <div class="privacy-info">
                                        <p><strong>Show Profile Photo</strong></p>
                                        <p class="text-muted">Display your photo to other users</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" @bind="settings.ShowProfilePhoto"
                                               @bind:after="OnSettingChanged" />
                                        <span class="toggle-slider"></span>
                                    </label>
                                </label>

                                <label class="privacy-item">
                                    <div class="privacy-info">
                                        <p><strong>Show Last Name</strong></p>
                                        <p class="text-muted">Display your full name or first name only</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" @bind="settings.ShowLastName"
                                               @bind:after="OnSettingChanged" />
                                        <span class="toggle-slider"></span>
                                    </label>
                                </label>

                                <label class="privacy-item">
                                    <div class="privacy-info">
                                        <p><strong>Show Online Status</strong></p>
                                        <p class="text-muted">Let others see when you're online</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" @bind="settings.ShowOnlineStatus"
                                               @bind:after="OnSettingChanged" />
                                        <span class="toggle-slider"></span>
                                    </label>
                                </label>
                            </div>
                        </div>

                        <div class="settings-card">
                            <h3 class="card-title">Data Sharing</h3>

                            <div class="privacy-options">
                                <label class="privacy-item">
                                    <div class="privacy-info">
                                        <p><strong>Analytics & Improvements</strong></p>
                                        <p class="text-muted">Help improve FindTradie with usage data</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" @bind="settings.ShareAnalytics"
                                               @bind:after="OnSettingChanged" />
                                        <span class="toggle-slider"></span>
                                    </label>
                                </label>

                                <label class="privacy-item">
                                    <div class="privacy-info">
                                        <p><strong>Personalized Recommendations</strong></p>
                                        <p class="text-muted">Get personalized job and tradie suggestions</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" @bind="settings.PersonalizedRecommendations"
                                               @bind:after="OnSettingChanged" />
                                        <span class="toggle-slider"></span>
                                    </label>
                                </label>
                            </div>
                        </div>

                        <div class="settings-card">
                            <h3 class="card-title">Blocked Users</h3>
                            @if (blockedUsers.Any())
                            {
                                <div class="blocked-list">
                                    @foreach (var user in blockedUsers)
                                    {
                                        <div class="blocked-item">
                                            <div class="blocked-info">
                                                <img src="@user.Photo" alt="@user.Name" />
                                                <span>@user.Name</span>
                                            </div>
                                            <button class="btn btn-sm btn-outline" @onclick="() => UnblockUser(user.Id)">
                                                Unblock
                                            </button>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <p class="text-muted">No blocked users</p>
                            }
                        </div>
                    </div>
                }
                else if (activeSection == "billing" && IsTradie)
                {
                    <!-- Billing & Subscription (Tradie Only) -->
                    <div class="settings-section">
                        <h2 class="section-title">Billing & Subscription</h2>
                        <p class="section-description">Manage your subscription and payment methods</p>

                        <div class="settings-card">
                            <h3 class="card-title">Current Plan</h3>
                            <div class="subscription-info">
                                <div class="plan-details">
                                    <h4>@settings.PlanName</h4>
                                    <p class="plan-price">$@settings.PlanPrice/month</p>
                                    <p class="text-muted">Next billing date: @settings.NextBillingDate</p>
                                </div>
                                <div class="plan-actions">
                                    <button class="btn btn-primary" @onclick="UpgradePlan">
                                        Upgrade Plan
                                    </button>
                                    <button class="btn btn-outline" @onclick="ViewPlans">
                                        View All Plans
                                    </button>
                                </div>
                            </div>

                            <div class="plan-features">
                                <h5>Your plan includes:</h5>
                                <ul>
                                    <li><i class="icon-check"></i> @settings.QuotesPerMonth quotes per month</li>
                                    <li><i class="icon-check"></i> Priority listing in search results</li>
                                    <li><i class="icon-check"></i> Advanced analytics</li>
                                    <li><i class="icon-check"></i> 24/7 support</li>
                                </ul>
                            </div>
                        </div>

                        <div class="settings-card">
                            <h3 class="card-title">Payment Methods</h3>
                            <div class="payment-methods">
                                @foreach (var method in paymentMethods)
                                {
                                    <div class="payment-method @(method.IsDefault ? "default" : "")">
                                        <div class="payment-info">
                                            <i class="icon-credit-card"></i>
                                            <div>
                                                <p><strong>@method.Type •••• @method.Last4</strong></p>
                                                <p class="text-muted">Expires @method.ExpiryDate</p>
                                            </div>
                                        </div>
                                        <div class="payment-actions">
                                            @if (method.IsDefault)
                                            {
                                                <span class="default-badge">Default</span>
                                            }
                                            else
                                            {
                                                <button class="btn btn-sm btn-outline"
                                                        @onclick="() => SetDefaultPayment(method.Id)">
                                                    Set Default
                                                </button>
                                            }
                                            <button class="btn btn-sm btn-outline text-danger"
                                                    @onclick="() => RemovePayment(method.Id)">
                                                Remove
                                            </button>
                                        </div>
                                    </div>
                                }
                                <button class="btn btn-outline" @onclick="AddPaymentMethod">
                                    <i class="icon-plus"></i> Add Payment Method
                                </button>
                            </div>
                        </div>

                        <div class="settings-card">
                            <h3 class="card-title">Billing History</h3>
                            <div class="billing-history">
                                <table class="history-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Description</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var invoice in billingHistory)
                                        {
                                            <tr>
                                                <td>@invoice.Date</td>
                                                <td>@invoice.Description</td>
                                                <td>$@invoice.Amount</td>
                                                <td>
                                                    <span class="status-badge @invoice.Status.ToLower()">
                                                        @invoice.Status
                                                    </span>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-text"
                                                            @onclick="() => DownloadInvoice(invoice.Id)">
                                                        <i class="icon-download"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                }
                else if (activeSection == "preferences")
                {
                    <!-- Preferences -->
                    <div class="settings-section">
                        <h2 class="section-title">Preferences</h2>
                        <p class="section-description">Customize your FindTradie experience</p>

                        <div class="settings-card">
                            <h3 class="card-title">Display Settings</h3>

                            <div class="form-group">
                                <label>Language</label>
                                <select class="form-control" @bind="settings.Language" @bind:after="OnSettingChanged">
                                    <option value="en">English</option>
                                    <option value="es">Spanish</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                    <option value="zh">Chinese</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Time Zone</label>
                                <select class="form-control" @bind="settings.TimeZone" @bind:after="OnSettingChanged">
                                    <option value="Australia/Sydney">Sydney (GMT+10)</option>
                                    <option value="Australia/Melbourne">Melbourne (GMT+10)</option>
                                    <option value="Australia/Brisbane">Brisbane (GMT+10)</option>
                                    <option value="Australia/Perth">Perth (GMT+8)</option>
                                    <option value="Australia/Adelaide">Adelaide (GMT+9:30)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Date Format</label>
                                <select class="form-control" @bind="settings.DateFormat" @bind:after="OnSettingChanged">
                                    <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                    <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                    <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Currency</label>
                                <select class="form-control" @bind="settings.Currency" @bind:after="OnSettingChanged">
                                    <option value="AUD">AUD - Australian Dollar</option>
                                    <option value="USD">USD - US Dollar</option>
                                    <option value="GBP">GBP - British Pound</option>
                                    <option value="EUR">EUR - Euro</option>
                                </select>
                            </div>
                        </div>

                        <div class="settings-card">
                            <h3 class="card-title">Communication Preferences</h3>

                            <div class="form-group">
                                <label>Preferred Contact Method</label>
                                <select class="form-control" @bind="settings.PreferredContact" @bind:after="OnSettingChanged">
                                    <option value="email">Email</option>
                                    <option value="phone">Phone</option>
                                    <option value="sms">SMS</option>
                                    <option value="in-app">In-App Messages</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Email Frequency</label>
                                <select class="form-control" @bind="settings.EmailFrequency" @bind:after="OnSettingChanged">
                                    <option value="immediate">Immediate</option>
                                    <option value="daily">Daily Digest</option>
                                    <option value="weekly">Weekly Summary</option>
                                    <option value="never">Never</option>
                                </select>
                            </div>
                        </div>
                    </div>
                }
                else if (activeSection == "connected")
                {
                    <!-- Connected Accounts -->
                    <div class="settings-section">
                        <h2 class="section-title">Connected Accounts</h2>
                        <p class="section-description">Manage your connected services and social accounts</p>

                        <div class="settings-card">
                            <h3 class="card-title">Social Accounts</h3>

                            <div class="connected-accounts">
                                <div class="account-item">
                                    <div class="account-info">
                                        <i class="icon-google"></i>
                                        <div>
                                            <p><strong>Google</strong></p>
                                            <p class="text-muted">
                                                @if (settings.GoogleConnected)
                                                {
                                                    <text>Connected as @settings.GoogleEmail</text>
                                                }
                                                else
                                                {
                                                    <text>Sign in with Google</text>
                                                }
                                            </p>
                                        </div>
                                    </div>
                                    @if (settings.GoogleConnected)
                                    {
                                        <button class="btn btn-outline" @onclick="DisconnectGoogle">
                                            Disconnect
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-primary" @onclick="ConnectGoogle">
                                            Connect
                                        </button>
                                    }
                                </div>

                                <div class="account-item">
                                    <div class="account-info">
                                        <i class="icon-facebook"></i>
                                        <div>
                                            <p><strong>Facebook</strong></p>
                                            <p class="text-muted">
                                                @if (settings.FacebookConnected)
                                                {
                                                    <text>Connected</text>
                                                }
                                                else
                                                {
                                                    <text>Share your projects on Facebook</text>
                                                }
                                            </p>
                                        </div>
                                    </div>
                                    @if (settings.FacebookConnected)
                                    {
                                        <button class="btn btn-outline" @onclick="DisconnectFacebook">
                                            Disconnect
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-primary" @onclick="ConnectFacebook">
                                            Connect
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="settings-card">
                            <h3 class="card-title">Third-Party Services</h3>

                            <div class="connected-accounts">
                                <div class="account-item">
                                    <div class="account-info">
                                        <i class="icon-calendar"></i>
                                        <div>
                                            <p><strong>Google Calendar</strong></p>
                                            <p class="text-muted">Sync your job schedule</p>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary" @onclick="ConnectCalendar">
                                        Connect
                                    </button>
                                </div>

                                @if (IsTradie)
                                {
                                    <div class="account-item">
                                        <div class="account-info">
                                            <i class="icon-tool"></i>
                                            <div>
                                                <p><strong>QuickBooks</strong></p>
                                                <p class="text-muted">Sync invoices and payments</p>
                                            </div>
                                        </div>
                                        <button class="btn btn-primary" @onclick="ConnectQuickBooks">
                                            Connect
                                        </button>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
                else if (activeSection == "data")
                {
                    <!-- Data & Privacy -->
                    <div class="settings-section">
                        <h2 class="section-title">Data & Privacy</h2>
                        <p class="section-description">Manage your data and privacy preferences</p>

                        <div class="settings-card">
                            <h3 class="card-title">Your Data</h3>

                            <div class="data-actions">
                                <div class="data-item">
                                    <div class="data-info">
                                        <i class="icon-download"></i>
                                        <div>
                                            <p><strong>Download Your Data</strong></p>
                                            <p class="text-muted">Get a copy of all your FindTradie data</p>
                                        </div>
                                    </div>
                                    <button class="btn btn-outline" @onclick="RequestDataDownload">
                                        Request Download
                                    </button>
                                </div>

                                <div class="data-item">
                                    <div class="data-info">
                                        <i class="icon-file"></i>
                                        <div>
                                            <p><strong>Data Portability</strong></p>
                                            <p class="text-muted">Export your data in a portable format</p>
                                        </div>
                                    </div>
                                    <button class="btn btn-outline" @onclick="ExportData">
                                        Export Data
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="settings-card">
                            <h3 class="card-title">Privacy Policy & Terms</h3>

                            <div class="legal-links">
                                <a href="/privacy-policy" class="legal-link" target="_blank">
                                    <i class="icon-shield"></i>
                                    <span>Privacy Policy</span>
                                    <i class="icon-external-link"></i>
                                </a>
                                <a href="/terms-of-service" class="legal-link" target="_blank">
                                    <i class="icon-file-text"></i>
                                    <span>Terms of Service</span>
                                    <i class="icon-external-link"></i>
                                </a>
                                <a href="/cookie-policy" class="legal-link" target="_blank">
                                    <i class="icon-cookie"></i>
                                    <span>Cookie Policy</span>
                                    <i class="icon-external-link"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                }

                <!-- Save Button (appears for all sections with changes) -->
                @if (hasChanges)
                {
                    <div class="save-bar">
                        <div class="save-info">
                            <i class="icon-info"></i>
                            <span>You have unsaved changes</span>
                        </div>
                        <div class="save-actions">
                            <button class="btn btn-outline" @onclick="DiscardChanges">Discard</button>
                            <button class="btn btn-primary" @onclick="SaveSettings" disabled="@isSaving">
                                @if (isSaving)
                                {
                                    <span class="spinner-small"></span>
                                    <text>Saving...</text>
                                }
                                else
                                {
                                    <text>Save Changes</text>
                                }
                            </button>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private UserSettings settings = new();
    private string activeSection = "account";
    private bool hasChanges = false;
    private bool isSaving = false;
    private bool IsCustomer = false;
    private bool IsTradie = false;
    private bool unreadNotificationSettings = false;
    private bool pushPermissionGranted = false;

    // Collections
    private List<Session> activeSessions = new();
    private List<BlockedUser> blockedUsers = new();
    private List<PaymentMethod> paymentMethods = new();
    private List<Invoice> billingHistory = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();

        if (!authState.User.Identity?.IsAuthenticated ?? true)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        var userType = authState.User.FindFirst("UserType")?.Value;
        IsCustomer = userType == "Customer" || userType == "1";
        IsTradie = userType == "Tradie" || userType == "ServiceProvider" || userType == "2";

        await LoadSettings();
        await LoadSessions();

        if (IsTradie)
        {
            await LoadBillingInfo();
        }
    }

    private async Task LoadSettings()
    {
        // Mock data
        settings = new UserSettings
            {
                FirstName = "John",
                LastName = "Smith",
                Email = "john.smith@example.com",
                EmailVerified = true,
                Phone = "0400 123 456",
                PhoneVerified = false,
                DateOfBirth = new DateTime(1985, 6, 15),
                PasswordLastChanged = "3 months ago",
                TwoFactorEnabled = false,
                Initials = "JS",
                Bio = "Professional plumber with 15+ years experience",
                Location = "Sydney, NSW",

                // Notifications
                EmailAccountUpdates = true,
                EmailQuoteReceived = true,
                EmailJobUpdates = true,
                EmailNewJobs = true,
                EmailQuoteAccepted = true,
                EmailMessages = true,
                EmailMarketing = false,
                SmsUrgent = true,
                SmsEmergencyJobs = false,

                // Privacy
                ShowProfilePhoto = true,
                ShowLastName = true,
                ShowOnlineStatus = false,
                ShareAnalytics = true,
                PersonalizedRecommendations = true,

                // Preferences
                Language = "en",
                TimeZone = "Australia/Sydney",
                DateFormat = "DD/MM/YYYY",
                Currency = "AUD",
                PreferredContact = "email",
                EmailFrequency = "immediate",

                // Billing (Tradie)
                PlanName = "Professional",
                PlanPrice = 99,
                NextBillingDate = "15 Feb 2024",
                QuotesPerMonth = 50,

                // Connected
                GoogleConnected = true,
                GoogleEmail = "john.smith@gmail.com",
                FacebookConnected = false
            };

        await Task.CompletedTask;
    }

    private async Task LoadSessions()
    {
        activeSessions = new List<Session>
        {
            new() { Id = Guid.NewGuid(), Device = "Chrome on Windows", Location = "Sydney, AU", LastActive = "Now", IsCurrent = true },
            new() { Id = Guid.NewGuid(), Device = "Safari on iPhone", Location = "Sydney, AU", LastActive = "2 hours ago", IsCurrent = false }
        };
        await Task.CompletedTask;
    }

    private async Task LoadBillingInfo()
    {
        paymentMethods = new List<PaymentMethod>
        {
            new() { Id = Guid.NewGuid(), Type = "Visa", Last4 = "4242", ExpiryDate = "12/25", IsDefault = true }
        };

        billingHistory = new List<Invoice>
        {
            new() { Id = Guid.NewGuid(), Date = "1 Jan 2024", Description = "Monthly Subscription", Amount = 99, Status = "Paid" },
            new() { Id = Guid.NewGuid(), Date = "1 Dec 2023", Description = "Monthly Subscription", Amount = 99, Status = "Paid" }
        };
        await Task.CompletedTask;
    }

    private void SetActiveSection(string section)
    {
        activeSection = section;
    }

    private void OnSettingChanged()
    {
        hasChanges = true;
    }

    private async Task SaveSettings()
    {
        isSaving = true;
        await Task.Delay(1500); // Simulate API call
        hasChanges = false;
        isSaving = false;
    }

    private void DiscardChanges()
    {
        hasChanges = false;
        _ = LoadSettings();
    }

    // Action methods (implement as needed)
    private async Task VerifyEmail() { }
    private async Task VerifyPhone() { }
    private void ChangePassword() => Navigation.NavigateTo("/change-password");
    private async Task OnTwoFactorToggle() { }
    private async Task RevokeSession(Guid id) { }
    private async Task RevokeAllSessions() { }
    private async Task DeactivateAccount() { }
    private async Task DeleteAccount() { }
    private async Task HandlePhotoUpload(InputFileChangeEventArgs e) { }
    private async Task RemovePhoto() { }
    private async Task RequestPushPermission() { }
    private async Task UnblockUser(Guid id) { }
    private void UpgradePlan() => Navigation.NavigateTo("/pricing");
    private void ViewPlans() => Navigation.NavigateTo("/pricing");
    private async Task SetDefaultPayment(Guid id) { }
    private async Task RemovePayment(Guid id) { }
    private void AddPaymentMethod() { }
    private async Task DownloadInvoice(Guid id) { }
    private async Task ConnectGoogle() { }
    private async Task DisconnectGoogle() { }
    private async Task ConnectFacebook() { }
    private async Task DisconnectFacebook() { }
    private async Task ConnectCalendar() { }
    private async Task ConnectQuickBooks() { }
    private async Task RequestDataDownload() { }
    private async Task ExportData() { }

    // Models
    private class UserSettings
    {
        // Account
        public string FirstName { get; set; } = "";
        public string LastName { get; set; } = "";
        public string Email { get; set; } = "";
        public bool EmailVerified { get; set; }
        public string Phone { get; set; } = "";
        public bool PhoneVerified { get; set; }
        public DateTime DateOfBirth { get; set; }
        public string PasswordLastChanged { get; set; } = "";
        public bool TwoFactorEnabled { get; set; }

        // Profile
        public string? ProfilePhoto { get; set; }
        public string Initials { get; set; } = "";
        public string Bio { get; set; } = "";
        public string Location { get; set; } = "";

        // Notifications
        public bool EmailAccountUpdates { get; set; }
        public bool EmailQuoteReceived { get; set; }
        public bool EmailJobUpdates { get; set; }
        public bool EmailNewJobs { get; set; }
        public bool EmailQuoteAccepted { get; set; }
        public bool EmailMessages { get; set; }
        public bool EmailMarketing { get; set; }
        public bool SmsUrgent { get; set; }
        public bool SmsEmergencyJobs { get; set; }

        // Privacy
        public bool ShowProfilePhoto { get; set; }
        public bool ShowLastName { get; set; }
        public bool ShowOnlineStatus { get; set; }
        public bool ShareAnalytics { get; set; }
        public bool PersonalizedRecommendations { get; set; }

        // Preferences
        public string Language { get; set; } = "en";
        public string TimeZone { get; set; } = "";
        public string DateFormat { get; set; } = "";
        public string Currency { get; set; } = "";
        public string PreferredContact { get; set; } = "";
        public string EmailFrequency { get; set; } = "";

        // Billing (Tradie)
        public string PlanName { get; set; } = "";
        public decimal PlanPrice { get; set; }
        public string NextBillingDate { get; set; } = "";
        public int QuotesPerMonth { get; set; }

        // Connected
        public bool GoogleConnected { get; set; }
        public string GoogleEmail { get; set; } = "";
        public bool FacebookConnected { get; set; }
    }

    private class Session
    {
        public Guid Id { get; set; }
        public string Device { get; set; } = "";
        public string Location { get; set; } = "";
        public string LastActive { get; set; } = "";
        public bool IsCurrent { get; set; }
    }

    private class BlockedUser
    {
        public Guid Id { get; set; }
        public string Name { get; set; } = "";
        public string Photo { get; set; } = "";
    }

    private class PaymentMethod
    {
        public Guid Id { get; set; }
        public string Type { get; set; } = "";
        public string Last4 { get; set; } = "";
        public string ExpiryDate { get; set; } = "";
        public bool IsDefault { get; set; }
    }

    private class Invoice
    {
        public Guid Id { get; set; }
        public string Date { get; set; } = "";
        public string Description { get; set; } = "";
        public decimal Amount { get; set; }
        public string Status { get; set; } = "";
    }
}