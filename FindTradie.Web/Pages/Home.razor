@page "/"
@using FindTradie.Services.TradieManagement.DTOs
@using FindTradie.Shared.Domain.Enums
@inject FindTradie.Web.Services.ITradieApiService TradieService
@inject NavigationManager Navigation

<PageTitle>FindTradie - Find Trusted Local Tradies</PageTitle>

<section class="hero-section">
    <div class="container">
        <div class="hero-content">
            <h1>Find Trusted Local Tradies</h1>
            <p>Connect with verified, available professionals in your area.</p>

            <div class="search-card">
                <h3>What service do you need?</h3>

                <form class="search-form">
                    <div class="form-group">
                        <label>Your location</label>
                        <input @bind="SearchLocation" type="text" placeholder="Enter suburb or postcode" class="form-control" />
                    </div>

                    <div class="form-group">
                        <label>Service needed</label>
                        <select @bind="SelectedCategory" class="form-control">
                            <option value="">Select a service</option>
                            @foreach (var c in ServiceCategories)
                            {
                                <option value="@((int)c.Key)">@c.Value</option>
                            }
                        </select>
                    </div>

                    <div class="form-group">
                        <label>When do you need this?</label>
                        <select @bind="SelectedUrgency" class="form-control">
                            <option value="week">Within a week</option>
                            <option value="month">Within a month</option>
                            <option value="urgent">Urgent (24 hours)</option>
                            <option value="emergency">Emergency (ASAP)</option>
                        </select>
                    </div>

                    <button type="button" class="btn-primary-large" @onclick="SearchTradies" disabled="@IsSearching">
                        Find Tradies →
                    </button>

                    <div class="divider-or">or</div>

                    <button type="button" class="btn-secondary-large" @onclick="NavigateToPostJob">
                        Post a Job
                    </button>
                </form>

                <div class="trust-badges-inline">
                    <div class="trust-badge-item">
                        <i class="fa-solid fa-circle-check"></i>
                        <span>Verified Tradies</span>
                    </div>
                    <div class="trust-badge-item">
                        <i class="fa-solid fa-shield-halved"></i>
                        <span>Fully Insured</span>
                    </div>
                    <div class="trust-badge-item">
                        <i class="fa-solid fa-comments-dollar"></i>
                        <span>Free Quotes</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="popular-services">
    <div class="container">
        <h2>Popular Services</h2>
        <p class="section-subtitle">Find trusted professionals for any home service</p>

        <div class="services-grid">
            <div class="service-card">
                <span class="availability-badge">245 Available</span>
                <div class="service-icon-wrapper">
                    <i class="fa-solid fa-wrench service-icon"></i>
                </div>
                <h3>Plumbing</h3>
            </div>

            <div class="service-card">
                <span class="availability-badge">189 Available</span>
                <div class="service-icon-wrapper">
                    <i class="fa-solid fa-bolt service-icon"></i>
                </div>
                <h3>Electrical</h3>
            </div>

            <div class="service-card">
                <span class="availability-badge">154 Available</span>
                <div class="service-icon-wrapper">
                    <i class="fa-solid fa-hammer service-icon"></i>
                </div>
                <h3>Carpentry</h3>
            </div>

            <div class="service-card">
                <span class="availability-badge">132 Available</span>
                <div class="service-icon-wrapper">
                    <i class="fa-solid fa-paint-roller service-icon"></i>
                </div>
                <h3>Painting</h3>
            </div>
        </div>
    </div>
</section>

<section class="trust-section">
    <div class="container">
        <div class="trust-items">
            <div class="trust-item">
                <div class="trust-item-icon">
                    <i class="fa-solid fa-shield-check"></i>
                </div>
                <h4>Verified & Insured</h4>
                <p>All tradies are vetted and carry insurance.</p>
            </div>
            <div class="trust-item">
                <div class="trust-item-icon">
                    <i class="fa-solid fa-clock"></i>
                </div>
                <h4>On-Time Service</h4>
                <p>We guarantee punctual arrivals.</p>
            </div>
            <div class="trust-item">
                <div class="trust-item-icon">
                    <i class="fa-solid fa-headset"></i>
                </div>
                <h4>Support</h4>
                <p>24/7 customer support.</p>
            </div>
        </div>
    </div>
</section>

@if (SearchResults?.Any() == true)
{
    <div class="search-results">
        <div class="container">
            <h3>Available Tradies Near You</h3>
            <div class="row">
                @foreach (var tradie in SearchResults)
                {
                    <div class="col-lg-4 col-md-6 mb-4">
                        <div class="tradie-card">
                            <div class="tradie-header">
                                <div class="tradie-avatar">
                                    <i class="fa-solid fa-user-hard-hat avatar-icon"></i>
                                </div>
                                <div class="tradie-info">
                                    <h5>@tradie.BusinessName</h5>
                                    <div class="rating">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            <span class="star @(i <= tradie.Rating ? "filled" : "")">★</span>
                                        }
                                        <span class="rating-text">@tradie.Rating.ToString("0.0") (@tradie.ReviewCount reviews)</span>
                                    </div>
                                </div>
                            </div>
                            <p class="tradie-description">@tradie.Description</p>
                            <div class="tradie-services mb-3">
                                @foreach (var category in tradie.ServiceCategories.Take(3))
                                {
                                    <span class="service-badge">@GetCategoryName(category)</span>
                                }
                            </div>
                            <div class="tradie-footer d-flex justify-content-between">
                                <div class="distance"><i class="fa-solid fa-location-dot"></i> @tradie.DistanceKm.ToString("0.0")km away</div>
                                <div class="availability">
                                    @if (tradie.IsAvailable)
                                    {
                                        <span class="status available">Available Now</span>
                                    }
                                    else
                                    {
                                        <span class="status busy">Busy</span>
                                    }
                                </div>
                            </div>
                            <div class="card-actions mt-3">
                                <button class="btn btn-outline-primary" @onclick="() => ViewProfile(tradie.Id)">View Profile</button>
                                <button class="btn btn-primary" @onclick="() => RequestQuote(tradie.Id)">Get Quote</button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

<section class="cta-tradies">
    <div class="container">
        <div class="cta-content">
            <h2>Are You a Tradie?</h2>
            <p>Join 500+ professionals growing their business with FindTradie</p>
            <a href="/register-tradie" class="btn-cta">Start Earning Today</a>
        </div>
    </div>
</section>

<button id="backToTop" class="back-to-top"><i class="fas fa-arrow-up"></i></button>

<div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="statusToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-body"></div>
    </div>
</div>

@code {
    private string SearchLocation = string.Empty;
    private string SelectedCategory = string.Empty;
    private string SelectedUrgency = "week";
    private bool IsSearching = false;
    private List<TradieProfileSummaryDto>? SearchResults;

    private Dictionary<ServiceCategory, string> ServiceCategories = new()
    {
        { ServiceCategory.Plumbing, "Plumbing" },
        { ServiceCategory.Electrical, "Electrical" },
        { ServiceCategory.Carpentry, "Carpentry" },
        { ServiceCategory.Painting, "Painting" },
        { ServiceCategory.Roofing, "Roofing" },
        { ServiceCategory.HVAC, "Heating & Cooling" },
        { ServiceCategory.Landscaping, "Landscaping" },
        { ServiceCategory.Cleaning, "Cleaning" },
        { ServiceCategory.Handyman, "Handyman" }
    };

    private async Task SearchTradies()
    {
        if (string.IsNullOrWhiteSpace(SearchLocation))
        {
            return;
        }

        IsSearching = true;
        StateHasChanged();

        try
        {
            var searchRequest = new SearchTradiesRequest(
                Latitude: -37.8136,
                Longitude: 144.9631,
                RadiusKm: 25,
                Categories: !string.IsNullOrEmpty(SelectedCategory) ?
                    new List<ServiceCategory> { (ServiceCategory)int.Parse(SelectedCategory) } : null,
                AvailableNow: SelectedUrgency == "urgent" || SelectedUrgency == "emergency"
            );

            var response = await TradieService.SearchTradiesAsync(searchRequest);

            if (response.Success && response.Data != null)
            {
                SearchResults = response.Data;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Search error: {ex.Message}");
        }
        finally
        {
            IsSearching = false;
            StateHasChanged();
        }
    }

    private string GetCategoryName(ServiceCategory category)
    {
        return ServiceCategories.TryGetValue(category, out var name) ? name : category.ToString();
    }

    private void ViewProfile(Guid tradieId)
    {
        Navigation.NavigateTo($"/tradie/{tradieId}");
    }

    private void RequestQuote(Guid tradieId)
    {
        Navigation.NavigateTo($"/post-job?tradieId={tradieId}");
    }

    private void NavigateToPostJob()
    {
        Navigation.NavigateTo("post-job");
    }
}
